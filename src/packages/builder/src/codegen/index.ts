import fs from 'fs';
import path from 'path';
import { executeCodegen } from '@graphql-codegen/cli';
import nearOperationFilePreset from '@graphql-codegen/near-operation-file-preset';

type CodegenOptions = {
	typesOutput: string[];
};

const content = `/* eslint-disable */
/* 
* This file is auto-generated by Graphweaver. 
* Please do not edit it directly.
*/`;

export const codeGenerator = async (schema: string, options: CodegenOptions) => {
	try {
		const files = await executeCodegen({
			cwd: process.cwd(),
			pluginLoader: async (plugin: string) => import(plugin),
			schema,
			ignoreNoDocuments: true,
			documents: ['./src/**/!(*.generated).{ts,tsx}'],
			generates: {
				'src/types.generated.ts': {
					config: {
						skipDocumentsValidation: {
							skipDuplicateValidation: true, // A flag to disable the validation for duplicate query and mutation names we don't need this as we are using near-operation-file
						},
					},
					plugins: [
						{
							add: {
								content,
							},
						},
						'typescript',
					],
				},
				'src/': {
					preset: nearOperationFilePreset,
					presetConfig: {
						extension: '.generated.ts',
						baseTypesPath: 'types.generated.ts',
					},
					plugins: [
						{
							add: {
								content,
							},
						},
						'typescript-operations',
						'typescript-react-apollo',
					],
				},
			},
		});

		// Ensure that the typesOutput directories exist
		console.log('Generating types in the following paths:');
		for (const outputPath of options.typesOutput) {
			const dirPath = path.dirname(path.join(process.cwd(), outputPath));
			if (!fs.existsSync(dirPath)) {
				fs.mkdirSync(dirPath, { recursive: true });
			}

			console.log(dirPath);
		}

		// Write the files to disk
		const writeOperations = files.flatMap((file) => [
			fs.promises.writeFile(path.join(process.cwd(), file.filename), file.content, 'utf8'),
			// We save the types to two locations src and .graphweaver / outdir
			...(file.filename === 'src/types.generated.ts'
				? options.typesOutput.map((outputPath: string) =>
						fs.promises.writeFile(outputPath, file.content, 'utf8')
				  )
				: []),
		]);

		// Write the files to disk
		await Promise.all(writeOperations);
	} catch (err: any) {
		const defaultStateMessage = `Unable to find any GraphQL type definitions for the following pointers:`;
		if (err.message && err.message.includes(defaultStateMessage)) {
			// do nothing for now and silently fail
		} else {
			console.log(err.message + `\n in ${err.source?.name}`);
		}
	}
};
